<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مُحقق الوضوء</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Amiri', serif;
            background-color: #FEE2E2;
        }
        .container {
            max-width: 800px;
        }
        #result-title {
            animation: fadeIn 1s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">
    <div class="container bg-white rounded-xl shadow-lg p-6 md:p-12 text-center">
        <h1 class="text-3xl md:text-5xl font-bold mb-4 text-pink-600">مُحقق الوضوء</h1>
        <p class="text-gray-700 mb-8 md:mb-12">
            اكتشف أخطاء الوضوء المحتملة في الصور التي تقوم بتحميلها.
        </p>

        <div class="mb-8">
            <input type="file" id="imageInput" accept="image/*" class="hidden">
            <label for="imageInput" class="cursor-pointer bg-pink-500 hover:bg-pink-600 text-white font-bold py-3 px-8 rounded-full shadow-lg transition-transform transform hover:scale-105">
                اختر صورة
            </label>
        </div>

        <div id="imagePreviewContainer" class="mb-8 hidden">
            <img id="imagePreview" src="#" alt="Image Preview" class="mx-auto rounded-lg max-h-96 w-auto shadow-md">
        </div>

        <div class="mb-8 hidden" id="loadingIndicator">
            <div class="flex items-center justify-center space-x-2">
                <div class="w-4 h-4 rounded-full animate-pulse bg-pink-600"></div>
                <div class="w-4 h-4 rounded-full animate-pulse bg-pink-600"></div>
                <div class="w-4 h-4 rounded-full animate-pulse bg-pink-600"></div>
            </div>
            <p class="mt-2 text-pink-600">جارِ التحليل...</p>
        </div>

        <div id="resultContainer" class="hidden">
            <h2 class="text-3xl font-bold text-pink-600 mb-4" id="result-title"></h2>
            <p class="text-gray-700 leading-relaxed text-lg" id="result-text"></p>
        </div>
    </div>

    <script>
        // Gemini API configuration
        // This code works in this specific environment, as it gets the API key from a secure variable.
        // It is not recommended to hardcode the key in a public repository like GitHub Pages.
        const apiKey = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : '';
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

        // Get elements
        const imageInput = document.getElementById('imageInput');
        const imagePreview = document.getElementById('imagePreview');
        const imagePreviewContainer = document.getElementById('imagePreviewContainer');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const resultContainer = document.getElementById('resultContainer');
        const resultTitle = document.getElementById('result-title');
        const resultText = document.getElementById('result-text');

        // Event listener for image selection
        imageInput.addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    imagePreview.src = e.target.result;
                    imagePreviewContainer.classList.remove('hidden');
                    analyzeImage(e.target.result);
                }
                reader.readAsDataURL(file);
            }
        });

        async function analyzeImage(base64Image) {
            loadingIndicator.classList.remove('hidden');
            resultContainer.classList.add('hidden');

            const mimeType = 'image/png';
            const base64Data = base64Image.split(',')[1];

            const prompt = "Please analyze this image and detect any potential mistakes in the wudu (ablution) process. Describe any issues clearly and provide guidance on how to correct them. Be very specific about which body part has an issue. If there are no issues, state that the wudu appears to be correct.";

            const payload = {
                contents: [
                    {
                        role: "user",
                        parts: [
                            { text: prompt },
                            {
                                inlineData: {
                                    mimeType: mimeType,
                                    data: base64Data
                                }
                            }
                        ]
                    }
                ],
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API error: ${JSON.stringify(errorData)}`);
                }

                const result = await response.json();
                const text = result?.candidates?.[0]?.content?.parts?.[0]?.text;

                if (text) {
                    displayResult(text);
                } else {
                    displayResult("عذراً، لم أتمكن من تحليل الصورة. يرجى المحاولة مرة أخرى.");
                }
            } catch (error) {
                console.error('Error analyzing image:', error);
                displayResult("حدث خطأ أثناء الاتصال بالخادم. يرجى المحاولة مرة أخرى.");
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        }

        function displayResult(text) {
            const isCorrect = text.includes("صحيح") || text.includes("correct") || text.includes("لا يوجد");
            resultTitle.textContent = isCorrect ? "الوضوء صحيح!" : "تنبيه: أخطاء محتملة";
            resultTitle.classList.remove('text-pink-600', 'text-green-600');
            resultTitle.classList.add(isCorrect ? 'text-green-600' : 'text-pink-600');
            resultText.textContent = text;
            resultContainer.classList.remove('hidden');
        }
    </script>
</body>
</html>
